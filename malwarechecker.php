<?php
require_once 'login.php';
$conn = new mysqli($hn, $un, $pw, $db);

if ($conn->connect_error)
    die("OOPS");

echo <<<_END
<html><head><title>PHP MYSQL PROJECT</title></head><body>
<form method='post' action='malwarechecker.php' enctype='multipart/form-data'><pre>
Select File: <input type='file' name='filename'>
<input type='submit' value='Upload'>
</pre>
</form>
_END;
if ($_FILES) {
    $checker = FALSE;
    $query = "SELECT * FROM malware";
    $result = $conn->query($query);
    if (! $result)
        die("OOPS");
    $num_of_rows = $result->num_rows;
    if ($num_of_rows == 0) {
        echo "No malware uploaded to our database";
    } else {
        $content = htmlentities(file_get_contents($_FILES['filename']['tmp_name']));
        for ($i = 0; $i < $num_of_rows; $i ++) {
            $result->data_seek($i);
            $row = $result->fetch_array(MYSQLI_NUM);
            $contents = $row[1];
            if (! empty($contents)) {
                if (strpos($content, $contents) !== false) {
                    echo "This file does contain malware";
                    $checker = TRUE;
                    break;
                }
            }
        }
        if ($checker == FALSE) {
            echo "This file doesn't contain malware";
        }
    }
    $result->close();
}

$conn->close();
?>
