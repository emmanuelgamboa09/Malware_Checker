<?php
require_once 'login.php';
$conn = new mysqli($hn, $un, $pw, $db);

if ($conn->connect_error)
    die("OOPS");

if (isset($_POST['submit'])) {
    $temp_name = mysql_entities_fix_string($conn, $_POST['malware_name']);
    $temp_file = mysql_entities_fix_string($conn, ($_FILES['file']['tmp_name']));
    if (! empty($temp_name) && ! empty($temp_file)) {
        $file = fopen($temp_file, "r");
        $contents = fread($file, 20);
        insertTable($conn, $temp_name, $contents);
        fclose($file);
    }
}
if (isset($_SERVER['PHP_AUTH_USER']) && isset($_SERVER['PHP_AUTH_PW'])) {
    $un = mysql_entities_fix_string($conn, $_SERVER['PHP_AUTH_USER']);
    $pw = mysql_entities_fix_string($conn, $_SERVER['PHP_AUTH_PW']);
    $query = "SELECT * FROM admins WHERE username = '$un'";
    $result = $conn->query($query);
    if (! $result)
        die("OOPS");
    if ($result->num_rows) {
        $row = $result->fetch_array(MYSQLI_ASSOC);
        if ($un == $row['username']) {
            $salt = $row['salt'];
            $token = hash('ripemd128', "$salt$pw");
            if ($token == $row['password']) {
                echo "Welcome";
                echo <<<_END
                <html><head><title>PHP MYSQL PROJECT</title></head><body>
                <form method='post' action='adminlogin.php' enctype='multipart/form-data'><pre>
                Malware Name <input type='text' name='malware_name'>
                <input type='file' name='file'>
                <button type='submit' name = 'submit'>SUBMIT MALWARE</button>
                </pre>
                </form>
                _END;
            } else
                die("Invalid information was entered");
        }
    } else
        die("Invalid information was entered");
    $result->close();
} else {
    header('WWW-Authenticate: Basic realm="Restricted Section"');
    header('HTTP/1.0 401 Unauthorized');
    die("Please enter your username and password");
}
$conn->close();

function mysql_entities_fix_string($conn, $string)
{
    return htmlentities(mysql_fix_string($conn, $string));
}

function insertTable($conn, $name, $file)
{
    $file = htmlentities($file);
    $query = "INSERT INTO malware(malware_name, file) VALUES ('$name', '$file')";
    $conn->query($query);
}

function mysql_fix_string($conn, $string)
{
    if (get_magic_quotes_gpc())
        $string = stripslashes($string);
    return $conn->real_escape_string($string);
}
?>